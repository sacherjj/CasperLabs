import pytest
import logging
from pyblake2 import blake2b


@pytest.fixture(scope='module')
def node(one_node_network_module_scope):
    return one_node_network_module_scope.docker_nodes[0]


@pytest.fixture(scope='module')
def client(node):
    return node.d_client


# TODO: At the moment it seems EE generates function pointer hash as if nonce was 0.
# This is a bug: https://github.com/CasperLabs/CasperLabs/pull/665#discussion_r294411087 

TABLE_FROM_MICHAL = """
nonce=0 counter=0 hash=[164, 102, 153, 51, 236, 214, 169, 167, 126, 44, 250, 247, 179, 214, 203, 229, 239, 69, 145, 25, 5, 153, 113, 55, 255, 188, 176, 201, 7, 4, 42, 100]                                       
nonce=0 counter=1 hash=[201, 123, 219, 72, 220, 218, 196, 8, 153, 155, 66, 213, 0, 56, 26, 117, 58, 115, 205, 209, 96, 73, 89, 3, 7, 155, 124, 250, 90, 64, 33, 161]                                              
nonce=0 counter=2 hash=[19, 139, 15, 184, 252, 148, 79, 127, 8, 247, 7, 237, 133, 28, 224, 206, 228, 83, 133, 177, 214, 61, 225, 167, 164, 83, 34, 159, 204, 21, 112, 65]                                         
nonce=1 counter=0 hash=[40, 187, 84, 61, 149, 153, 87, 11, 8, 127, 115, 154, 177, 24, 64, 119, 110, 49, 39, 103, 248, 25, 47, 60, 132, 200, 80, 11, 5, 132, 64, 160]                                              
nonce=1 counter=1 hash=[25, 163, 109, 131, 31, 124, 41, 185, 236, 114, 217, 3, 151, 135, 34, 41, 131, 156, 136, 140, 248, 77, 118, 167, 226, 213, 63, 106, 29, 164, 56, 197]                                      
nonce=1 counter=2 hash=[67, 232, 122, 169, 14, 106, 54, 34, 212, 177, 47, 78, 119, 93, 170, 83, 253, 198, 239, 179, 90, 172, 18, 205, 87, 44, 42, 226, 77, 179, 219, 69]                                          
nonce=2 counter=0 hash=[141, 28, 213, 149, 230, 231, 61, 223, 143, 211, 37, 248, 146, 126, 101, 96, 197, 73, 164, 185, 147, 226, 1, 127, 25, 96, 126, 228, 231, 147, 193, 252]                                    
nonce=2 counter=1 hash=[123, 239, 52, 63, 17, 49, 159, 62, 82, 97, 231, 200, 170, 137, 232, 141, 102, 206, 226, 242, 197, 37, 172, 13, 25, 215, 70, 50, 119, 31, 98, 112]                                         
nonce=2 counter=2 hash=[6, 24, 237, 214, 52, 141, 39, 226, 219, 18, 0, 191, 251, 243, 228, 142, 54, 202, 96, 215, 28, 40, 156, 38, 190, 212, 183, 221, 157, 53, 89, 185]                                          
nonce=3 counter=0 hash=[112, 228, 46, 108, 216, 57, 71, 94, 33, 246, 154, 133, 28, 166, 176, 34, 191, 39, 176, 42, 121, 192, 209, 54, 188, 193, 20, 24, 17, 224, 208, 105]                                        
nonce=3 counter=1 hash=[241, 252, 76, 111, 116, 47, 151, 4, 47, 200, 15, 190, 44, 183, 5, 72, 3, 223, 199, 77, 72, 248, 137, 76, 70, 22, 154, 31, 223, 57, 124, 147]                                              
nonce=3 counter=2 hash=[82, 23, 194, 214, 199, 60, 39, 85, 191, 105, 2, 248, 151, 167, 55, 57, 144, 97, 131, 178, 135, 159, 136, 152, 57, 219, 72, 21, 250, 63, 20, 182]                                          
nonce=4 counter=0 hash=[245, 250, 252, 78, 217, 1, 125, 208, 254, 74, 122, 141, 168, 215, 37, 40, 30, 168, 234, 6, 133, 205, 117, 189, 86, 86, 186, 31, 59, 216, 223, 123]                                        
nonce=4 counter=1 hash=[178, 239, 206, 73, 93, 163, 63, 156, 20, 68, 97, 252, 205, 21, 15, 2, 141, 176, 1, 86, 128, 109, 45, 218, 103, 232, 87, 193, 133, 240, 222, 73]                                           
nonce=4 counter=2 hash=[159, 137, 16, 182, 32, 183, 81, 20, 198, 44, 200, 186, 187, 107, 246, 193, 12, 170, 214, 184, 127, 236, 206, 225, 193, 152, 197, 89, 161, 254, 3, 193]                                    
nonce=5 counter=0 hash=[223, 85, 213, 143, 244, 83, 244, 44, 108, 163, 104, 146, 59, 43, 245, 170, 253, 71, 159, 191, 171, 213, 144, 68, 112, 70, 17, 18, 130, 7, 192, 144]                                       
nonce=5 counter=1 hash=[242, 79, 174, 147, 186, 252, 22, 160, 8, 106, 166, 105, 230, 105, 127, 157, 219, 192, 20, 123, 255, 74, 156, 96, 16, 232, 158, 58, 98, 74, 113, 39]                                       
nonce=5 counter=2 hash=[189, 74, 157, 9, 100, 227, 142, 31, 206, 154, 198, 95, 228, 28, 191, 202, 143, 187, 187, 237, 155, 121, 92, 245, 243, 60, 229, 63, 48, 64, 105, 69]                                       
nonce=6 counter=0 hash=[121, 148, 145, 135, 145, 34, 219, 134, 226, 94, 28, 75, 44, 155, 223, 193, 174, 154, 179, 10, 68, 209, 73, 167, 38, 211, 250, 52, 235, 255, 17, 237]                                      
nonce=6 counter=1 hash=[241, 175, 9, 109, 240, 26, 105, 46, 28, 16, 132, 193, 127, 42, 7, 238, 159, 252, 151, 144, 170, 0, 149, 253, 46, 176, 108, 227, 128, 57, 57, 227]                                         
nonce=6 counter=2 hash=[111, 189, 216, 108, 85, 80, 132, 149, 116, 14, 113, 253, 163, 187, 178, 242, 0, 203, 182, 189, 81, 181, 253, 50, 241, 242, 170, 135, 242, 214, 93, 128]                                   
nonce=7 counter=0 hash=[27, 253, 55, 43, 146, 182, 212, 248, 237, 146, 97, 171, 153, 232, 67, 73, 181, 175, 135, 172, 193, 58, 189, 117, 208, 42, 46, 174, 97, 168, 190, 161]                                     
nonce=7 counter=1 hash=[7, 72, 94, 163, 232, 210, 111, 22, 158, 104, 70, 49, 35, 141, 236, 36, 133, 29, 6, 155, 27, 101, 2, 249, 163, 182, 79, 175, 184, 107, 173, 255]                                           
nonce=7 counter=2 hash=[139, 145, 177, 161, 17, 56, 207, 206, 114, 40, 92, 247, 215, 253, 144, 253, 181, 68, 226, 33, 171, 146, 69, 90, 53, 181, 47, 89, 96, 171, 229, 201]                                       
nonce=8 counter=0 hash=[1, 118, 179, 41, 58, 160, 72, 216, 122, 87, 21, 220, 178, 200, 208, 225, 8, 223, 76, 41, 61, 171, 38, 167, 99, 124, 43, 220, 49, 1, 70, 155]                                              
nonce=8 counter=1 hash=[131, 222, 91, 180, 171, 163, 34, 151, 155, 254, 122, 34, 230, 69, 23, 74, 177, 120, 224, 200, 205, 105, 86, 137, 90, 57, 10, 36, 213, 179, 17, 46]                                        
nonce=8 counter=2 hash=[127, 228, 130, 73, 95, 123, 181, 129, 232, 182, 106, 169, 224, 215, 193, 155, 229, 16, 13, 26, 92, 58, 88, 92, 219, 226, 111, 2, 5, 177, 115, 207]                                        
nonce=9 counter=0 hash=[105, 4, 214, 201, 122, 32, 80, 4, 101, 134, 177, 49, 252, 189, 18, 153, 34, 52, 110, 236, 225, 167, 32, 67, 203, 164, 89, 223, 144, 215, 16, 141]                                         
nonce=9 counter=1 hash=[145, 130, 187, 81, 162, 22, 236, 123, 185, 83, 193, 18, 229, 101, 166, 156, 190, 169, 181, 118, 205, 177, 126, 242, 140, 156, 163, 221, 19, 135, 215, 127]                                
nonce=9 counter=2 hash=[105, 12, 118, 161, 38, 130, 56, 203, 24, 145, 213, 69, 126, 146, 148, 222, 246, 214, 96, 116, 126, 207, 81, 32, 230, 184, 36, 227, 121, 249, 84, 144]
"""



def test_revert_subcall(client, node):
    # This contract calls another contract that calls revert(2) 
    block_hash = node.deploy_and_propose(session_contract = 'test_subcall_revert_define.wasm',
                                         payment_contract = 'test_subcall_revert_define.wasm')

    r = client.show_deploys(block_hash)[0]
    assert not r.is_error
    assert r.error_message == ''

    deploy_hash = r.deploy.deploy_hash

    r = client.show_deploy(deploy_hash)
    assert r.deploy.deploy_hash == deploy_hash


    block_hash = node.deploy_and_propose(session_contract = 'test_subcall_revert_call.wasm',
                                         payment_contract = 'test_subcall_revert_call.wasm')
    r = client.show_deploys(block_hash)[0]
    assert r.is_error
    assert r.error_message == "Exit code: 2"



def test_revert_direct(client, node):
    # This contract calls revert(1) directly
    block_hash = node.deploy_and_propose(session_contract = 'test_direct_revert_call.wasm',
                                         payment_contract = 'test_direct_revert_call.wasm')

    r = client.show_deploys(block_hash)[0]
    assert r.is_error
    assert r.error_message == "Exit code: 1"
